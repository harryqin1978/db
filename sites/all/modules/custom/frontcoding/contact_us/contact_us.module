<?php



/**
* Implementation of hook_permission()
*/
function contact_us_permission() {

  return array(
    'contact us update information' => array(
      'title' => t('Update contact us information'),
    ),
    'contact us update location' => array(
      'title' => t('Update contact us location'),
    ),
  );

}



/**
 * Implements hook_menu().
 */
function contact_us_menu() {

  $items['admin/config/webmaster/contact-us'] = array(
    'title' => 'Contact Us',
    'description' => 'Contact us content management.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('contact_us_admin_information'),
    'access arguments' => array('contact us update information'),
    'position' => 'left',
    'weight' => 1000,
    'file' => 'contact_us.admin.inc',
  );

  $items['admin/config/webmaster/contact-us/information'] = array(
    'title' => 'Information',
    'description' => 'Update information.',
    'access arguments' => array('contact us update information'),
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -10,
    'file' => 'contact_us.admin.inc',
  );

  $items['admin/config/webmaster/contact-us/location'] = array(
    'title' => 'Location',
    'description' => 'Update location.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('contact_us_admin_location'),
    'access arguments' => array('contact us update location'),
    'file' => 'contact_us.admin.inc',
    'type' => MENU_LOCAL_TASK,
  );

  $items['contact-us'] = array(
    'page callback' => 'contact_us_page',
    'access arguments' => array('access content'),
    'title' => 'Contact Us',
    'type' => MENU_CALLBACK,
  );

  return $items;

}



function contact_us_page() {

  return _contact_us_build_content();

}



/**
 * Implements hook_block_info().
 *
 * This hook declares what blocks are provided by the module.
 */
function contact_us_block_info() {
  // This hook returns an array, each component of which is an array of block
  // information. The array keys are the 'delta' values used in other block
  // hooks.

  // The required block information is a block description, which is shown
  // to the site administrator in the list of possible blocks. You can also
  // provide initial settings for block weight, status, etc.

  // Many options are defined in hook_block_info():
  $blocks['contact_us_content'] = array(
    // info: The name of the block.
    'info' => t('Contact us content'),
    // Block caching options (per role, per user, etc.)
    'cache' => DRUPAL_CACHE_PER_ROLE, // default
  );

  return $blocks;

}



/**
 * Implements hook_block_view().
 *
 * This hook generates the contents of the blocks themselves.
 */
function contact_us_block_view($delta = '') {
  //The $delta parameter tells us which block is being requested.
  switch ($delta) {
    case 'contact_us_content':
      // The subject is displayed at the top of the block. Note that it
      // should be passed through t() for translation. The title configured
      // for the block using Drupal UI supercedes this one.
      $block['subject'] = t('Contact us');
      // The content of the block is typically generated by calling a custom
      // function.
      $block['content'] = _contact_us_build_content();
      break;
  }
  return $block;
}



function _contact_us_build_content() {

  $content_array = array();
  
  if (variable_get('contact_us_information_address')) {
    $content_array['address'] = theme('contact_us_item', array('itemclass'=>'address', 'label' => t('Address'), 'content' => variable_get('contact_us_information_address')));
  }

  if (variable_get('contact_us_information_phone')) {
    $content_array['phone'] = theme('contact_us_item', array('itemclass'=>'phone', 'label' => t('Phone number'), 'content' => variable_get('contact_us_information_phone')));
  }

  if (variable_get('contact_us_information_fax')) {
    $content_array['fax'] = theme('contact_us_item', array('itemclass'=>'fax', 'label' => t('Fax number'), 'content' => variable_get('contact_us_information_fax')));
  }

  if (variable_get('contact_us_information_email')) {
    $content_array['email'] = theme('contact_us_item', array('itemclass'=>'email', 'label' => t('Email'), 'content' => variable_get('contact_us_information_email')));
  }

  if (variable_get('contact_us_location_maptype')=='google_map') {
    global $language;
    $_keyword = urlencode(variable_get('contact_us_location_address'));
    $content = '<iframe width="425" height="350" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="http://ditu.google.cn/maps?f=q&amp;source=s_q&amp;hl='.$language->language.'&amp;geocode=&amp;q='.$_keyword.'&amp;output=embed"></iframe><br /><a href="http://ditu.google.cn/maps?f=q&amp;source=embed&amp;hl=zh-CN&amp;geocode=&amp;q='.$_keyword.'">'.t('View big map').'</a>';
    $content_array['map_google'] = theme(
      'contact_us_item', array(
        'itemclass'=>'map-google', 
        'label' => t('Map'), 
        'content' => $content
      )
    );
  }

  if (variable_get('contact_us_location_maptype')=='upload_map') {
    $content_array['map_upload'] = theme(
      'contact_us_item', array(
        'itemclass'=>'map-upload', 
        'label' => t('Map'), 
        'content' => theme('image_style', array('style_name' => 'large', 'path' => variable_get('contact_us_location_mapupload'), 'getsize' => FALSE))
      )
    );
  }

  return theme(
    'contact_us_content', array(
      'val' => $content_array,
    )
  );

}



/**
 * Implements hook_theme().
 *
 * This lets us tell Drupal about our theme functions and their arguments.
 */
function contact_us_theme() {
  return array(

    'contact_us_item' => array(
      'variables' => array(
        'label' => NULL,
        'content' => NULL,
      ),
      'template' => 'contact_us_item',
    ),

    'contact_us_content' => array(
      'variables' => array(
        'val' => array(),
      ),
      'template' => 'contact_us_content',
    ),

  );
}



/**
 * A custom theme function.
 */
 /*
function theme_contact_us_item($variables) {
  $output = '<div class="contact-us-item">';
  $output .= '<div class="label">'.$variables['label'].'</div>';
  $output .= '<div class="content">'.$variables['content'].'</div>';
  $output .= '</div>';
  return $output;
}
*/
